define("org/forgerock/openam/ui/user/delegates/AuthNDelegate",["org/forgerock/commons/ui/common/util/Constants","org/forgerock/commons/ui/common/main/AbstractDelegate","org/forgerock/commons/ui/common/main/Configuration","org/forgerock/commons/ui/common/main/EventManager","org/forgerock/commons/ui/common/util/CookieHelper","org/forgerock/commons/ui/common/main/Router","org/forgerock/commons/ui/common/main/i18nManager","org/forgerock/openam/ui/user/delegates/SessionDelegate","org/forgerock/commons/ui/common/components/Messages","org/forgerock/openam/ui/common/util/RealmHelper"],function(e,t,n,r,i,s,o,u,a,f){var l=new t(e.host+"/"+e.context+"/json/"),c=[],h={};return l.begin=function(){var e,t={},r,s=$.Deferred();return h=_.clone(n.globalData.auth),n.globalData.auth.urlParams&&_.extend(t,n.globalData.auth.urlParams),r=i.getCookie(n.globalData.auth.cookieName),r&&(t.sessionUpgradeSSOTokenId=r),e=f.decorateURIWithSubRealm("__subrealm__/authenticate"),f.getOverrideRealm()&&(t.realm=f.getOverrideRealm()),e=e+"?"+$.param(t),l.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:"",url:e,errorsHandlers:{unauthorized:{status:"401"}}}).done(function(e){s.resolve(e)}).fail(function(e){var t=$.parseJSON(e.responseText);t.hasOwnProperty("authId")?l.submitRequirements(t).done(function(e){l.resetProcess(),s.resolve(e)}).fail(function(){s.reject()}):s.reject()}),s},l.handleRequirements=function(e){e.hasOwnProperty("authId")?c.push(e):e.hasOwnProperty("tokenId")&&_.each(n.globalData.auth.cookieDomains,function(t){i.setCookie(n.globalData.auth.cookieName,e.tokenId,"","/",t,n.globalData.secureCookie)})},l.submitRequirements=function(t){var n=$.Deferred(),i=function(e){l.handleRequirements(e),n.resolve(e)},s=function(e){var t=c.length;l.resetProcess(),n.reject(t,e)},o=function(e){e.detail&&e.detail.failureUrl&&(console.log(e.detail.failureUrl),window.location.href=e.detail.failureUrl)},u;return u=f.decorateURIWithRealm("__subrealm__/authenticate"),l.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:JSON.stringify(t),url:u,errorsHandlers:{unauthorized:{status:"401"},timeout:{status:"408"},"Internal Server Error ":{status:"500"}}}).then(i,function(t){var u,f,h,p=c.length,d=t.responseJSON.message,v=null;if(t.status===408)u=c[0],l.resetProcess(),l.begin().done(function(t){l.handleRequirements(t),t.hasOwnProperty("authId")?p===1?(u.authId=t.authId,l.submitRequirements(u).done(i).fail(s)):(r.sendEvent(e.EVENT_DISPLAY_MESSAGE_REQUEST,"loginTimeout"),n.resolve(t)):n.resolve(t)}).fail(s);else if(t.status===500)h={message:d,type:"error"},a.messages.addMessage(h);else{f=$.parseJSON(t.responseText);if(f.hasOwnProperty("authId"))l.submitRequirements(f).done(i).fail(s);else{switch(f.message){case"User Account Locked":v="loginFailureLockout";break;case"Maximum Sessions Limit Reached.":v="maxSessionsLimitOrSessionQuota";break;case" Your password has expired. Please contact service desk to reset your password":v="loginFailureLockout";break;default:v="authenticationFailed"}s(v),o(f)}}}),n},l.resetProcess=function(){c=[]},l.getRequirements=function(e){var t=$.Deferred();return c.length===0||!_.isEqual(n.globalData.auth,h)?l.begin(e).done(function(e){l.handleRequirements(e),t.resolve(e)}).fail(function(e){t.reject()}):t.resolve(c[c.length-1]),t},l.setGoToUrl=function(t,n){var r={};return r.goto=n,l.serviceCall({type:"POST",headers:{"Accept-API-Version":"protocol=1.0,resource=2.0"},data:JSON.stringify(r),url:"",serviceUrl:e.host+"/"+e.context+"/json/users?_action=validateGoto",errorsHandlers:{"Bad Request":{status:400}}})},l})